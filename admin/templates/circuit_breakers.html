{{define "content"}}
<div class="page-header">
    <h1 class="page-title">ç†”æ–­å™¨é¢æ¿</h1>
</div>

<div class="card">
    <div class="card-header">
        ç†”æ–­å™¨åˆ—è¡¨
        <button class="btn btn-sm btn-secondary" onclick="refreshCircuitBreakers()" style="float: right;">åˆ·æ–°</button>
    </div>
    <div class="card-body" style="padding: 0;">
        {{if .Breakers}}
        <table class="table" id="breakersTable">
            <thead>
                <tr>
                    <th>æœåŠ¡åç§°</th>
                    <th>çŠ¶æ€</th>
                    <th>æ€»è¯·æ±‚æ•°</th>
                    <th>æˆåŠŸæ•°</th>
                    <th>å¤±è´¥æ•°</th>
                    <th>è¿ç»­æˆåŠŸ</th>
                    <th>è¿ç»­å¤±è´¥</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {{range .Breakers}}
                <tr data-service="{{.Service}}">
                    <td>
                        <strong>{{.Service}}</strong>
                    </td>
                    <td>
                        <span class="status-badge {{cbStateClass .State}}">{{cbStateLabel .State}}</span>
                    </td>
                    <td>{{.Requests}}</td>
                    <td style="color: #059669;">{{.TotalSuccesses}}</td>
                    <td style="color: #dc2626;">{{.TotalFailures}}</td>
                    <td>{{.ConsecutiveSuccesses}}</td>
                    <td>{{.ConsecutiveFailures}}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="resetCircuitBreaker('{{.Service}}')">
                            é‡ç½®
                        </button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ”Œ</div>
            <p>æš‚æ— å·²æ³¨å†Œçš„ç†”æ–­å™¨</p>
        </div>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-header">ç†”æ–­å™¨çŠ¶æ€è¯´æ˜</div>
    <div class="card-body">
        <div class="detail-list" style="grid-template-columns: repeat(3, 1fr);">
            <div class="detail-item">
                <span class="status-badge cb-closed" style="margin-bottom: 8px;">å…³é—­ (CLOSED)</span>
                <span class="detail-value" style="font-size: 0.8125rem; color: #6b7280;">
                    æ­£å¸¸çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚æ­£å¸¸é€šè¿‡
                </span>
            </div>
            <div class="detail-item">
                <span class="status-badge cb-open" style="margin-bottom: 8px;">æ‰“å¼€ (OPEN)</span>
                <span class="detail-value" style="font-size: 0.8125rem; color: #6b7280;">
                    ç†”æ–­çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚è¢«æ‹’ç»
                </span>
            </div>
            <div class="detail-item">
                <span class="status-badge cb-half-open" style="margin-bottom: 8px;">åŠå¼€ (HALF_OPEN)</span>
                <span class="detail-value" style="font-size: 0.8125rem; color: #6b7280;">
                    æ¢æµ‹çŠ¶æ€ï¼Œå…è®¸éƒ¨åˆ†è¯·æ±‚é€šè¿‡
                </span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">ä½¿ç”¨è¯´æ˜</div>
    <div class="card-body">
        <div class="alert alert-info" style="margin: 0;">
            <p><strong>ç†”æ–­å™¨</strong> ç”¨äºä¿æŠ¤ä¸‹æ¸¸æœåŠ¡ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼š</p>
            <ul style="margin: 10px 0 0 20px;">
                <li>å½“è¿ç»­å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œç†”æ–­å™¨ä¼šæ‰“å¼€ï¼ˆOPENï¼‰</li>
                <li>æ‰“å¼€çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚ä¼šè¢«å¿«é€Ÿå¤±è´¥ï¼Œä¸ä¼šè°ƒç”¨ä¸‹æ¸¸æœåŠ¡</li>
                <li>ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼ˆHALF_OPENï¼‰ï¼Œå…è®¸éƒ¨åˆ†è¯·æ±‚æ¢æµ‹</li>
                <li>å¦‚æœæ¢æµ‹æˆåŠŸï¼Œç†”æ–­å™¨å…³é—­ï¼ˆCLOSEDï¼‰ï¼›å¦‚æœå¤±è´¥ï¼Œé‡æ–°æ‰“å¼€</li>
                <li>ç‚¹å‡»"é‡ç½®"æŒ‰é’®å¯ä»¥æ‰‹åŠ¨å°†ç†”æ–­å™¨é‡ç½®ä¸ºå…³é—­çŠ¶æ€</li>
            </ul>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
async function refreshCircuitBreakers() {
    try {
        const data = await apiRequest('/api/circuit-breakers');
        
        const tbody = document.querySelector('#breakersTable tbody');
        if (!tbody) {
            location.reload();
            return;
        }
        
        if (data.length === 0) {
            location.reload();
            return;
        }
        
        // æ›´æ–°è¡¨æ ¼æ•°æ®
        data.forEach(breaker => {
            const row = document.querySelector(`tr[data-service="${breaker.service}"]`);
            if (row) {
                const cells = row.querySelectorAll('td');
                cells[1].innerHTML = `<span class="status-badge ${getCbStateClass(breaker.state)}">${getCbStateLabel(breaker.state)}</span>`;
                cells[2].textContent = breaker.requests;
                cells[3].textContent = breaker.total_successes;
                cells[4].textContent = breaker.total_failures;
                cells[5].textContent = breaker.consecutive_successes;
                cells[6].textContent = breaker.consecutive_failures;
            }
        });
        
        showAlert('æ•°æ®å·²åˆ·æ–°', 'success');
    } catch (error) {
        showAlert('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
    }
}

async function resetCircuitBreaker(service) {
    if (!confirm(`ç¡®å®šè¦é‡ç½®ç†”æ–­å™¨ "${service}" å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        await apiRequest(`/api/circuit-breakers/${encodeURIComponent(service)}/reset`, {
            method: 'POST'
        });
        
        showAlert(`ç†”æ–­å™¨ "${service}" å·²é‡ç½®`, 'success');
        
        // åˆ·æ–°æ•°æ®
        setTimeout(refreshCircuitBreakers, 500);
    } catch (error) {
        showAlert('é‡ç½®å¤±è´¥: ' + error.message, 'error');
    }
}

function getCbStateClass(state) {
    const classes = {
        'CLOSED': 'cb-closed',
        'OPEN': 'cb-open',
        'HALF_OPEN': 'cb-half-open'
    };
    return classes[state] || 'status-unknown';
}

function getCbStateLabel(state) {
    const labels = {
        'CLOSED': 'å…³é—­',
        'OPEN': 'æ‰“å¼€',
        'HALF_OPEN': 'åŠå¼€'
    };
    return labels[state] || state;
}

// è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯10ç§’ï¼‰
setInterval(refreshCircuitBreakers, 10000);
</script>
{{end}}
