{{define "content"}}
<div class="page-header">
    <h1 class="page-title">äº‹åŠ¡åˆ—è¡¨</h1>
</div>

<div class="card">
    <div class="card-header">ç­›é€‰æ¡ä»¶</div>
    <div class="card-body">
        <form method="GET" action="/transactions" class="form-inline">
            <div class="form-group">
                <label class="form-label">çŠ¶æ€</label>
                <select name="status" class="form-control" multiple style="min-width: 200px; height: 80px;">
                    <option value="CREATED"{{if hasStatus .Filter.Status "CREATED"}} selected{{end}}>å·²åˆ›å»º</option>
                    <option value="LOCKED"{{if hasStatus .Filter.Status "LOCKED"}} selected{{end}}>å·²é”å®š</option>
                    <option value="EXECUTING"{{if hasStatus .Filter.Status "EXECUTING"}} selected{{end}}>æ‰§è¡Œä¸­</option>
                    <option value="CONFIRMING"{{if hasStatus .Filter.Status "CONFIRMING"}} selected{{end}}>ç¡®è®¤ä¸­</option>
                    <option value="COMPLETED"{{if hasStatus .Filter.Status "COMPLETED"}} selected{{end}}>å·²å®Œæˆ</option>
                    <option value="FAILED"{{if hasStatus .Filter.Status "FAILED"}} selected{{end}}>å¤±è´¥</option>
                    <option value="COMPENSATING"{{if hasStatus .Filter.Status "COMPENSATING"}} selected{{end}}>è¡¥å¿ä¸­</option>
                    <option value="COMPENSATED"{{if hasStatus .Filter.Status "COMPENSATED"}} selected{{end}}>å·²è¡¥å¿</option>
                    <option value="COMPENSATION_FAILED"{{if hasStatus .Filter.Status "COMPENSATION_FAILED"}} selected{{end}}>è¡¥å¿å¤±è´¥</option>
                    <option value="CANCELLED"{{if hasStatus .Filter.Status "CANCELLED"}} selected{{end}}>å·²å–æ¶ˆ</option>
                    <option value="TIMEOUT"{{if hasStatus .Filter.Status "TIMEOUT"}} selected{{end}}>è¶…æ—¶</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">äº‹åŠ¡ç±»å‹</label>
                <input type="text" name="tx_type" class="form-control" value="{{.Filter.TxType}}" placeholder="è¾“å…¥äº‹åŠ¡ç±»å‹">
            </div>
            <div class="form-group">
                <label class="form-label">å¼€å§‹æ—¶é—´</label>
                <input type="datetime-local" name="start_time" class="form-control" value="{{.Filter.StartTime}}">
            </div>
            <div class="form-group">
                <label class="form-label">ç»“æŸæ—¶é—´</label>
                <input type="datetime-local" name="end_time" class="form-control" value="{{.Filter.EndTime}}">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">ç­›é€‰</button>
                <a href="/transactions" class="btn btn-secondary">é‡ç½®</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        äº‹åŠ¡åˆ—è¡¨
        <span style="float: right; font-weight: normal; color: #6b7280;">
            å…± {{.Pagination.Total}} æ¡è®°å½•ï¼Œç¬¬ {{.Pagination.CurrentPage}}/{{.Pagination.TotalPages}} é¡µ
            <button class="btn btn-sm btn-secondary" onclick="refreshTransactions()" style="margin-left: 10px;">åˆ·æ–°</button>
        </span>
    </div>
    <div class="card-body" style="padding: 0;">
        {{if .Transactions}}
        <table class="table">
            <thead>
                <tr>
                    <th>äº‹åŠ¡ID</th>
                    <th>ç±»å‹</th>
                    <th>çŠ¶æ€</th>
                    <th>è¿›åº¦</th>
                    <th>é‡è¯•æ¬¡æ•°</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {{range .Transactions}}
                <tr>
                    <td>
                        <a href="/transactions/{{.TxID}}" class="table-link">{{.TxID}}</a>
                    </td>
                    <td>{{.TxType}}</td>
                    <td>
                        <span class="status-badge {{statusClass .Status}}">{{statusLabel .Status}}</span>
                    </td>
                    <td>{{.CurrentStep}}/{{.TotalSteps}}</td>
                    <td>{{.RetryCount}}</td>
                    <td>{{formatTime .CreatedAt}}</td>
                    <td>{{formatTime .UpdatedAt}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„äº‹åŠ¡</p>
        </div>
        {{end}}
    </div>
</div>

{{if gt .Pagination.TotalPages 1}}
<div class="pagination">
    {{if .Pagination.HasPrev}}
    <a href="{{paginationURL .Filter (sub .Pagination.CurrentPage 1)}}" class="pagination-item">ä¸Šä¸€é¡µ</a>
    {{else}}
    <span class="pagination-item disabled">ä¸Šä¸€é¡µ</span>
    {{end}}
    
    {{range paginationRange .Pagination.CurrentPage .Pagination.TotalPages}}
    {{if eq . $.Pagination.CurrentPage}}
    <span class="pagination-item active">{{.}}</span>
    {{else}}
    <a href="{{paginationURL $.Filter .}}" class="pagination-item">{{.}}</a>
    {{end}}
    {{end}}
    
    {{if .Pagination.HasNext}}
    <a href="{{paginationURL .Filter (add .Pagination.CurrentPage 1)}}" class="pagination-item">ä¸‹ä¸€é¡µ</a>
    {{else}}
    <span class="pagination-item disabled">ä¸‹ä¸€é¡µ</span>
    {{end}}
</div>
{{end}}
{{end}}

{{define "scripts"}}
<script>
// åˆ·æ–°äº‹åŠ¡åˆ—è¡¨
function refreshTransactions() {
    location.reload();
}

// è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
let autoRefresh = false;
let refreshInterval;

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    if (autoRefresh) {
        refreshInterval = setInterval(() => {
            location.reload();
        }, 30000);
        showAlert('å·²å¼€å¯è‡ªåŠ¨åˆ·æ–°ï¼ˆ30ç§’ï¼‰', 'info');
    } else {
        clearInterval(refreshInterval);
        showAlert('å·²å…³é—­è‡ªåŠ¨åˆ·æ–°', 'info');
    }
}
</script>
{{end}}
