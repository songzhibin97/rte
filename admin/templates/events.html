{{define "content"}}
<div class="page-header">
    <h1 class="page-title">äº‹ä»¶æ—¥å¿—</h1>
</div>

<div class="card">
    <div class="card-header">ç­›é€‰æ¡ä»¶</div>
    <div class="card-body">
        <form method="GET" action="/events" class="form-inline">
            <div class="form-group">
                <label class="form-label">äº‹ä»¶ç±»å‹</label>
                <select name="type" class="form-control" style="min-width: 180px;">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    {{range .EventTypes}}
                    <option value="{{.}}"{{if eq . $.Filter.Type}} selected{{end}}>{{eventTypeLabel .}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">äº‹åŠ¡ID</label>
                <input type="text" name="tx_id" class="form-control" value="{{.Filter.TxID}}" placeholder="è¾“å…¥äº‹åŠ¡ID">
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">ç­›é€‰</button>
                <a href="/events" class="btn btn-secondary">é‡ç½®</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        äº‹ä»¶åˆ—è¡¨
        <button class="btn btn-sm btn-secondary" onclick="location.reload()" style="float: right;">åˆ·æ–°</button>
    </div>
    <div class="card-body" style="padding: 0;">
        {{if .Events}}
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 60px;">ID</th>
                    <th>äº‹ä»¶ç±»å‹</th>
                    <th>äº‹åŠ¡ID</th>
                    <th>äº‹åŠ¡ç±»å‹</th>
                    <th>æ­¥éª¤åç§°</th>
                    <th>æ—¶é—´</th>
                    <th style="width: 80px;">è¯¦æƒ…</th>
                </tr>
            </thead>
            <tbody>
                {{range .Events}}
                <tr class="event-row" data-event-id="{{.ID}}">
                    <td>{{.ID}}</td>
                    <td>
                        <span class="status-badge {{eventTypeClass .Type}}">{{eventTypeLabel .Type}}</span>
                    </td>
                    <td>
                        {{if .TxID}}
                        <a href="/transactions/{{.TxID}}" class="table-link">{{.TxID}}</a>
                        {{else}}
                        -
                        {{end}}
                    </td>
                    <td>{{if .TxType}}{{.TxType}}{{else}}-{{end}}</td>
                    <td>{{if .StepName}}{{.StepName}}{{else}}-{{end}}</td>
                    <td>{{formatTime .Timestamp}}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="toggleEventDetail({{.ID}})">
                            å±•å¼€
                        </button>
                    </td>
                </tr>
                <tr class="event-detail-row" id="event-detail-{{.ID}}" style="display: none;">
                    <td colspan="7" style="background: #f8f9fa; padding: 0;">
                        <div style="padding: 15px;">
                            {{if .Error}}
                            <div class="alert alert-error" style="margin-bottom: 10px;">
                                <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>{{.Error}}
                            </div>
                            {{end}}
                            
                            {{if .Data}}
                            <div>
                                <span class="detail-label">äº‹ä»¶æ•°æ®</span>
                                <pre class="json-display" style="margin-top: 5px;">{{toJSON .Data}}</pre>
                            </div>
                            {{else}}
                            <p style="color: #6b7280;">æš‚æ— è¯¦ç»†æ•°æ®</p>
                            {{end}}
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“œ</div>
            <p>æš‚æ— äº‹ä»¶è®°å½•</p>
        </div>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-header">äº‹ä»¶ç±»å‹è¯´æ˜</div>
    <div class="card-body">
        <div class="detail-list" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="detail-item">
                <span class="status-badge" style="background-color: #dbeafe; color: #1e40af; margin-bottom: 5px;">tx_created</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡åˆ›å»º</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #e0e7ff; color: #3730a3; margin-bottom: 5px;">tx_started</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡å¼€å§‹æ‰§è¡Œ</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #d1fae5; color: #065f46; margin-bottom: 5px;">tx_completed</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡å®Œæˆ</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #fee2e2; color: #991b1b; margin-bottom: 5px;">tx_failed</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡å¤±è´¥</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #f3f4f6; color: #374151; margin-bottom: 5px;">tx_cancelled</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡å–æ¶ˆ</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #fef3c7; color: #92400e; margin-bottom: 5px;">tx_compensating</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡è¡¥å¿ä¸­</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #e0e7ff; color: #3730a3; margin-bottom: 5px;">tx_compensated</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">äº‹åŠ¡å·²è¡¥å¿</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #fee2e2; color: #991b1b; margin-bottom: 5px;">tx_compensation_failed</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">è¡¥å¿å¤±è´¥</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #dbeafe; color: #1e40af; margin-bottom: 5px;">step_started</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">æ­¥éª¤å¼€å§‹</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #d1fae5; color: #065f46; margin-bottom: 5px;">step_completed</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">æ­¥éª¤å®Œæˆ</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #fee2e2; color: #991b1b; margin-bottom: 5px;">step_failed</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">æ­¥éª¤å¤±è´¥</span>
            </div>
            <div class="detail-item">
                <span class="status-badge" style="background-color: #e0e7ff; color: #3730a3; margin-bottom: 5px;">step_compensated</span>
                <span class="detail-value" style="font-size: 0.75rem; color: #6b7280;">æ­¥éª¤å·²è¡¥å¿</span>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
function toggleEventDetail(eventId) {
    const detailRow = document.getElementById('event-detail-' + eventId);
    const btn = document.querySelector(`tr[data-event-id="${eventId}"] button`);
    
    if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        btn.textContent = 'æ”¶èµ·';
    } else {
        detailRow.style.display = 'none';
        btn.textContent = 'å±•å¼€';
    }
}

// è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
setInterval(() => {
    location.reload();
}, 30000);
</script>
{{end}}
