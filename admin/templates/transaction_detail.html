{{define "content"}}
<div class="page-header">
    <h1 class="page-title">
        <a href="/transactions" style="color: #6b7280; text-decoration: none;">äº‹åŠ¡åˆ—è¡¨</a>
        <span style="color: #d1d5db;"> / </span>
        äº‹åŠ¡è¯¦æƒ…
    </h1>
</div>

<div id="alert-container" class="alert-container"></div>

<div class="card">
    <div class="card-header">
        åŸºæœ¬ä¿¡æ¯
        <span class="status-badge {{statusClass .Transaction.Status}}" style="float: right;">
            {{statusLabel .Transaction.Status}}
        </span>
    </div>
    <div class="card-body">
        <div class="detail-list">
            <div class="detail-item">
                <span class="detail-label">äº‹åŠ¡ID</span>
                <span class="detail-value">{{.Transaction.TxID}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">äº‹åŠ¡ç±»å‹</span>
                <span class="detail-value">{{.Transaction.TxType}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">å½“å‰æ­¥éª¤</span>
                <span class="detail-value">{{.Transaction.CurrentStep}} / {{.Transaction.TotalSteps}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">é‡è¯•æ¬¡æ•°</span>
                <span class="detail-value">{{.Transaction.RetryCount}} / {{.Transaction.MaxRetries}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ç‰ˆæœ¬å·</span>
                <span class="detail-value">{{.Transaction.Version}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">åˆ›å»ºæ—¶é—´</span>
                <span class="detail-value">{{formatTime .Transaction.CreatedAt}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">æ›´æ–°æ—¶é—´</span>
                <span class="detail-value">{{formatTime .Transaction.UpdatedAt}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">é”å®šæ—¶é—´</span>
                <span class="detail-value">{{formatTimePtr .Transaction.LockedAt}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">å®Œæˆæ—¶é—´</span>
                <span class="detail-value">{{formatTimePtr .Transaction.CompletedAt}}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">è¶…æ—¶æ—¶é—´</span>
                <span class="detail-value">{{formatTimePtr .Transaction.TimeoutAt}}</span>
            </div>
        </div>
        
        {{if .Transaction.ErrorMsg}}
        <div class="alert alert-error" style="margin-top: 15px;">
            <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>{{.Transaction.ErrorMsg}}
        </div>
        {{end}}
    </div>
</div>

{{if or .CanForceComplete .CanForceCancel .CanRetry}}
<div class="card">
    <div class="card-header">æ“ä½œ</div>
    <div class="card-body">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            {{if .CanForceComplete}}
            <button class="btn btn-warning" onclick="showOperationModal('force-complete', 'å¼ºåˆ¶å®Œæˆ')">
                å¼ºåˆ¶å®Œæˆ
            </button>
            {{end}}
            {{if .CanForceCancel}}
            <button class="btn btn-danger" onclick="showOperationModal('force-cancel', 'å¼ºåˆ¶å–æ¶ˆ')">
                å¼ºåˆ¶å–æ¶ˆ
            </button>
            {{end}}
            {{if .CanRetry}}
            <button class="btn btn-primary" onclick="retryTransaction()">
                é‡è¯•
            </button>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{if .Transaction.LockKeys}}
<div class="card">
    <div class="card-header">é”å®šé”®</div>
    <div class="card-body">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            {{range .Transaction.LockKeys}}
            <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 4px; font-family: monospace; font-size: 0.875rem;">{{.}}</span>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{if .Transaction.Input}}
<div class="card">
    <div class="card-header collapsible" onclick="toggleCollapsible(this)">
        è¾“å…¥å‚æ•° â–¼
    </div>
    <div class="collapsible-content show">
        <pre class="json-display">{{toJSON .Transaction.Input}}</pre>
    </div>
</div>
{{end}}

{{if .Transaction.Output}}
<div class="card">
    <div class="card-header collapsible" onclick="toggleCollapsible(this)">
        è¾“å‡ºç»“æœ â–¼
    </div>
    <div class="collapsible-content show">
        <pre class="json-display">{{toJSON .Transaction.Output}}</pre>
    </div>
</div>
{{end}}

<div class="card">
    <div class="card-header">æ­¥éª¤åˆ—è¡¨ ({{len .Steps}})</div>
    <div class="card-body" style="padding: 0;">
        {{if .Steps}}
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 60px;">#</th>
                    <th>æ­¥éª¤åç§°</th>
                    <th>çŠ¶æ€</th>
                    <th>é‡è¯•æ¬¡æ•°</th>
                    <th>å¼€å§‹æ—¶é—´</th>
                    <th>å®Œæˆæ—¶é—´</th>
                    <th style="width: 80px;">è¯¦æƒ…</th>
                </tr>
            </thead>
            <tbody>
                {{range .Steps}}
                <tr class="step-row" data-step-index="{{.StepIndex}}">
                    <td>{{.StepIndex}}</td>
                    <td>{{.StepName}}</td>
                    <td>
                        <span class="status-badge {{stepStatusClass .Status}}">{{stepStatusLabel .Status}}</span>
                    </td>
                    <td>{{.RetryCount}}</td>
                    <td>{{formatTimePtr .StartedAt}}</td>
                    <td>{{formatTimePtr .CompletedAt}}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="toggleStepDetail({{.StepIndex}})">
                            å±•å¼€
                        </button>
                    </td>
                </tr>
                <tr class="step-detail-row" id="step-detail-{{.StepIndex}}" style="display: none;">
                    <td colspan="7" style="background: #f8f9fa; padding: 0;">
                        <div style="padding: 15px;">
                            {{if .IdempotencyKey}}
                            <div class="detail-item" style="margin-bottom: 10px;">
                                <span class="detail-label">å¹‚ç­‰æ€§Key</span>
                                <span class="detail-value" style="font-family: monospace;">{{.IdempotencyKey}}</span>
                            </div>
                            {{end}}
                            
                            {{if .ErrorMsg}}
                            <div class="alert alert-error" style="margin-bottom: 10px;">
                                <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>{{.ErrorMsg}}
                            </div>
                            {{end}}
                            
                            {{if .Input}}
                            <div style="margin-bottom: 10px;">
                                <span class="detail-label">è¾“å…¥æ•°æ®</span>
                                <pre class="json-display" style="margin-top: 5px;">{{toJSON .Input}}</pre>
                            </div>
                            {{end}}
                            
                            {{if .Output}}
                            <div>
                                <span class="detail-label">è¾“å‡ºæ•°æ®</span>
                                <pre class="json-display" style="margin-top: 5px;">{{toJSON .Output}}</pre>
                            </div>
                            {{end}}
                            
                            {{if and (not .Input) (not .Output) (not .ErrorMsg)}}
                            <p style="color: #6b7280;">æš‚æ— è¯¦ç»†æ•°æ®</p>
                            {{end}}
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <p>æš‚æ— æ­¥éª¤è®°å½•</p>
        </div>
        {{end}}
    </div>
</div>

<!-- æ“ä½œç¡®è®¤æ¨¡æ€æ¡† -->
<div id="operationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">ç¡®è®¤æ“ä½œ</h3>
            <button class="modal-close" onclick="hideModal('operationModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalMessage" style="margin-bottom: 15px;"></p>
            <div class="form-group">
                <label class="form-label">æ“ä½œåŸå› ï¼ˆå¿…å¡«ï¼‰</label>
                <textarea id="operationReason" class="form-control" rows="3" placeholder="è¯·è¾“å…¥æ“ä½œåŸå› ..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideModal('operationModal')">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="confirmBtn" onclick="confirmOperation()">ç¡®è®¤</button>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
const txID = '{{.Transaction.TxID}}';
let currentOperation = '';

function toggleStepDetail(stepIndex) {
    const detailRow = document.getElementById('step-detail-' + stepIndex);
    const btn = document.querySelector(`tr[data-step-index="${stepIndex}"] button`);
    
    if (detailRow.style.display === 'none') {
        detailRow.style.display = 'table-row';
        btn.textContent = 'æ”¶èµ·';
    } else {
        detailRow.style.display = 'none';
        btn.textContent = 'å±•å¼€';
    }
}

function showOperationModal(operation, title) {
    currentOperation = operation;
    document.getElementById('modalTitle').textContent = 'ç¡®è®¤' + title;
    document.getElementById('modalMessage').textContent = `æ‚¨ç¡®å®šè¦å¯¹äº‹åŠ¡ ${txID} æ‰§è¡Œ"${title}"æ“ä½œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
    document.getElementById('operationReason').value = '';
    
    const confirmBtn = document.getElementById('confirmBtn');
    if (operation === 'force-cancel') {
        confirmBtn.className = 'btn btn-danger';
    } else {
        confirmBtn.className = 'btn btn-warning';
    }
    
    showModal('operationModal');
}

async function confirmOperation() {
    const reason = document.getElementById('operationReason').value.trim();
    if (!reason) {
        alert('è¯·è¾“å…¥æ“ä½œåŸå› ');
        return;
    }
    
    try {
        await apiRequest(`/api/transactions/${txID}/${currentOperation}`, {
            method: 'POST',
            body: JSON.stringify({ reason: reason })
        });
        
        hideModal('operationModal');
        showAlert('æ“ä½œæˆåŠŸ', 'success');
        
        // åˆ·æ–°é¡µé¢
        setTimeout(() => {
            location.reload();
        }, 1000);
    } catch (error) {
        showAlert('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
}

async function retryTransaction() {
    if (!confirm(`ç¡®å®šè¦é‡è¯•äº‹åŠ¡ ${txID} å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        await apiRequest(`/api/transactions/${txID}/retry`, {
            method: 'POST',
            body: JSON.stringify({})
        });
        
        showAlert('é‡è¯•å·²è§¦å‘', 'success');
        
        // åˆ·æ–°é¡µé¢
        setTimeout(() => {
            location.reload();
        }, 1000);
    } catch (error) {
        showAlert('é‡è¯•å¤±è´¥: ' + error.message, 'error');
    }
}
</script>
{{end}}
